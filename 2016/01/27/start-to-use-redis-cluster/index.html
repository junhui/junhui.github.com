<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="my daily technical solution and learning notes."><title>初步使用redis cluster集群 | Junhuih Notes</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-71924500-1','auto');ga('send','pageview');    </script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">初步使用redis cluster集群</h1><a id="logo" href="/.">Junhuih Notes</a><p class="description">Web, Solution</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">初步使用redis cluster集群</h1><div class="post-meta">2016-01-27 | <span class="categories">分类于<a href="/categories/bigdata/"> bigdata</a></span></div><span data-disqus-identifier="2016/01/27/start-to-use-redis-cluster/" class="disqus-comment-count"></span><div class="post-content"><p>Redis Cluster是Redis官方在3.0版本后提供的官方集群支持，在使用时比较简单，下面是简单的步骤。</p>
<h2 id="u573A_u666F_uFF1A"><a href="#u573A_u666F_uFF1A" class="headerlink" title="场景："></a>场景：</h2><ul>
<li>开始使用6个实例，按照3主3从的方式进行部署</li>
<li>数据操作，查看数据分布</li>
<li>然后添加一个新的主</li>
<li>数据操作，分配slot</li>
<li>再添加一个新的从</li>
<li>实验一个主挂掉的场景</li>
</ul>
<h2 id="u57FA_u672C_u96C6_u7FA4Redis_u5B9E_u4F8B_u8BBE_u5B9A"><a href="#u57FA_u672C_u96C6_u7FA4Redis_u5B9E_u4F8B_u8BBE_u5B9A" class="headerlink" title="基本集群Redis实例设定"></a>基本集群Redis实例设定</h2><p>由于实验时，只使用了一个物理机器，所以这里分别用不同的端口(7000~7005)来建立redis实例。</p>
<p>每个端口建立一个独立的文件夹，用来存贮配置文件，RDB文件和node.conf文件。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir <span class="number">7000</span> <span class="number">7001</span> <span class="number">7002</span> <span class="number">7003</span> <span class="number">7004</span> <span class="number">7005</span></span><br></pre></td></tr></table></figure>
<p>每个文件夹里放置对应的redis.config （如果没有，可以从<a href="http://download.redis.io/redis-stable/redis.conf" target="_blank" rel="external">官方</a>下载，并根据需要修改)。</p>
<p>建立cluster时，注意下面几个配置：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">daemonize yes # &#31243;&#24207;&#21518;&#21488;&#36816;&#34892;&#10;port 7000 # &#27880;&#24847;&#27599;&#20010;&#23454;&#20363;&#30340;&#31471;&#21475;&#35774;&#23450;&#10;cluster-enabled yes&#10;cluster-config-file nodes.conf&#10;cluster-node-timeout 5000</span><br></pre></td></tr></table></figure></p>
<p>最终的文件夹为：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  tree .</span><br><span class="line">.</span><br><span class="line">├── <span class="number">7000</span></span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7001</span></span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7002</span></span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7003</span></span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7004</span></span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7005</span></span><br><span class="line">    └── redis.conf</span><br><span class="line"><span class="number">6</span> directories, <span class="number">6</span> files</span><br></pre></td></tr></table></figure></p>
<p>运行redis时，可以建立一个bash文件来一次运行所有实例：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  cat runcluster.sh</span><br><span class="line"><span class="keyword">for</span> (( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i )); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="number">700</span><span class="variable">$i</span> &amp;&amp; redis-server redis.conf &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">➜  $  ./runcluster.sh</span><br></pre></td></tr></table></figure></p>
<p>这时，可以查看redis的运行情况：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  ps -ef | grep redis</span><br><span class="line">  <span class="number">501</span> <span class="number">85482</span>     <span class="number">1</span>   <span class="number">0</span>  <span class="number">3</span>:<span class="number">10</span>PM ??         <span class="number">0</span>:<span class="number">00.02</span> redis-server *:<span class="number">7000</span> [cluster]</span><br><span class="line">  <span class="number">501</span> <span class="number">85484</span>     <span class="number">1</span>   <span class="number">0</span>  <span class="number">3</span>:<span class="number">10</span>PM ??         <span class="number">0</span>:<span class="number">00.02</span> redis-server *:<span class="number">7001</span> [cluster]</span><br><span class="line">  <span class="number">501</span> <span class="number">85486</span>     <span class="number">1</span>   <span class="number">0</span>  <span class="number">3</span>:<span class="number">10</span>PM ??         <span class="number">0</span>:<span class="number">00.02</span> redis-server *:<span class="number">7002</span> [cluster]</span><br><span class="line">  <span class="number">501</span> <span class="number">85488</span>     <span class="number">1</span>   <span class="number">0</span>  <span class="number">3</span>:<span class="number">10</span>PM ??         <span class="number">0</span>:<span class="number">00.02</span> redis-server *:<span class="number">7003</span> [cluster]</span><br><span class="line">  <span class="number">501</span> <span class="number">85490</span>     <span class="number">1</span>   <span class="number">0</span>  <span class="number">3</span>:<span class="number">10</span>PM ??         <span class="number">0</span>:<span class="number">00.02</span> redis-server *:<span class="number">7004</span> [cluster]</span><br><span class="line">  <span class="number">501</span> <span class="number">85492</span>     <span class="number">1</span>   <span class="number">0</span>  <span class="number">3</span>:<span class="number">10</span>PM ??         <span class="number">0</span>:<span class="number">00.02</span> redis-server *:<span class="number">7005</span> [cluster]</span><br></pre></td></tr></table></figure></p>
<h2 id="u521B_u5EFA_u96C6_u7FA4"><a href="#u521B_u5EFA_u96C6_u7FA4" class="headerlink" title="创建集群"></a>创建集群</h2><p>Redis本身没有直接提供集群的创建，而是通过官方提供的一个小工具<code>redis-trib.rb</code>来操作集群信息，这个是一个基于ruby写的小工具，在redis源文件里，或者可以单独官方下载。</p>
<p>redis-trib里提供了cluster的常用操作方法，如下：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  ../redis-trib.rb <span class="built_in">help</span></span><br><span class="line">Usage: redis-trib &lt;<span class="built_in">command</span>&gt; &lt;options&gt; &lt;arguments ...&gt;</span><br><span class="line"></span><br><span class="line">  create          host1:port1 ... hostN:portN</span><br><span class="line">                  --replicas &lt;arg&gt;</span><br><span class="line">  check           host:port</span><br><span class="line">  info            host:port</span><br><span class="line">  fix             host:port</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">  reshard         host:port</span><br><span class="line">                  --from &lt;arg&gt;</span><br><span class="line">                  --to &lt;arg&gt;</span><br><span class="line">                  --slots &lt;arg&gt;</span><br><span class="line">                  --yes</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">                  --pipeline &lt;arg&gt;</span><br><span class="line">  rebalance       host:port</span><br><span class="line">                  --weight &lt;arg&gt;</span><br><span class="line">                  --auto-weights</span><br><span class="line">                  --threshold &lt;arg&gt;</span><br><span class="line">                  --use-empty-masters</span><br><span class="line">                  --timeout &lt;arg&gt;</span><br><span class="line">                  --simulate</span><br><span class="line">                  --pipeline &lt;arg&gt;</span><br><span class="line">  add-node        new_host:new_port existing_host:existing_port</span><br><span class="line">                  --slave</span><br><span class="line">                  --master-id &lt;arg&gt;</span><br><span class="line">  del-node        host:port node_id</span><br><span class="line">  <span class="built_in">set</span>-timeout     host:port milliseconds</span><br><span class="line">  call            host:port <span class="built_in">command</span> arg arg .. arg</span><br><span class="line">  import          host:port</span><br><span class="line">                  --from &lt;arg&gt;</span><br><span class="line">                  --copy</span><br><span class="line">                  --replace</span><br><span class="line">  <span class="built_in">help</span>            (show this <span class="built_in">help</span>)</span><br><span class="line"></span><br><span class="line">For check, fix, reshard, del-node, <span class="built_in">set</span>-timeout you can specify the host and port of any working node <span class="keyword">in</span> the cluster.</span><br></pre></td></tr></table></figure></p>
<p>创建集群时，可以通过这样把所有正在执行状态的redis实例关联起来（这里要注意，在创建cluster时指定的ip要时将来client要使用的ip，因为将来因client操作需要redis cluster做rediect动作时，会返回这个ip，如果为如127.0.0.1这种本机ip，可能导致无法访问）：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  ../redis-trib.rb create --replicas <span class="number">1</span> <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span> <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span> <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span> <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span> <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span> <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span></span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on <span class="number">6</span> nodes...</span><br><span class="line">Using <span class="number">3</span> masters:</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span></span><br><span class="line">Adding replica <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span> to <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">Adding replica <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span> to <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span></span><br><span class="line">Adding replica <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span> to <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span></span><br><span class="line">M: f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">   slots:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">M: <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span></span><br><span class="line">   slots:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">M: bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span></span><br><span class="line">   slots:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">S: <span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span></span><br><span class="line">   replicates f822e285d00305a3158408185abf838639b3db3e</span><br><span class="line">S: <span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span></span><br><span class="line">   replicates <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861</span><br><span class="line">S: <span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span></span><br><span class="line">   replicates bc86c1677869e05b6119139a838b06181f8378a2</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept):</span><br></pre></td></tr></table></figure></p>
<p>注意，执行过程中，会提示对应的slots分配情况，如果没有问题，输入yes后继续执行：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join......</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span>)</span><br><span class="line">M: f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">   slots:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">M: <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span></span><br><span class="line">   slots:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">M: bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span></span><br><span class="line">   slots:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">M: <span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) master</span><br><span class="line">   replicates f822e285d00305a3158408185abf838639b3db3e</span><br><span class="line">M: <span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) master</span><br><span class="line">   replicates <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861</span><br><span class="line">M: <span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) master</span><br><span class="line">   replicates bc86c1677869e05b6119139a838b06181f8378a2</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br></pre></td></tr></table></figure></p>
<p>集群正式生成（这里可以观察上面的信息，里面包含对应的集群信息以及slots的分配）。</p>
<p>这时，查看目录结构，你会发现对应新生成的dump.rdb和nodes.conf文件：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  tree</span><br><span class="line">.</span><br><span class="line">├── <span class="number">7000</span></span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7001</span></span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7002</span></span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7003</span></span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7004</span></span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── <span class="number">7005</span></span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">└── runcluster.sh</span><br><span class="line"></span><br><span class="line"><span class="number">6</span> directories, <span class="number">19</span> files</span><br></pre></td></tr></table></figure></p>
<p>查看nodes.conf，里面就是描述的具体的clust信息，如：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  cat <span class="number">7002</span>/nodes.conf</span><br><span class="line"><span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span> slave f822e285d00305a3158408185abf838639b3db3e <span class="number">0</span> <span class="number">1453937827236</span> <span class="number">4</span> connected</span><br><span class="line"><span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span> master - <span class="number">0</span> <span class="number">1453937829255</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br><span class="line"><span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span> slave <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">0</span> <span class="number">1453937828246</span> <span class="number">5</span> connected</span><br><span class="line"><span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span> slave bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">0</span> <span class="number">1453937825215</span> <span class="number">6</span> connected</span><br><span class="line">bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span> myself,master - <span class="number">0</span> <span class="number">0</span> <span class="number">3</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br><span class="line">f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span> master - <span class="number">0</span> <span class="number">1453937826226</span> <span class="number">1</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line">vars currentEpoch <span class="number">6</span> lastVoteEpoch <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>这里，7000/7001/7002是对应的主（master)，7003/7004/7005是分别对应的从(slave)。</p>
<h2 id="u57FA_u672C_u96C6_u7FA4_u6D4B_u8BD5"><a href="#u57FA_u672C_u96C6_u7FA4_u6D4B_u8BD5" class="headerlink" title="基本集群测试"></a>基本集群测试</h2><p>可以通过redis-cli链接集群进行简单的测试，链接时，注意要制定<code>-c</code>来标示是链接集群的：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~  redis-cli --help</span><br><span class="line">redis-cli <span class="number">3.0</span>.<span class="number">6</span></span><br><span class="line"></span><br><span class="line">Usage: redis-cli [OPTIONS] [cmd [arg [arg ...]]]</span><br><span class="line">  -h &lt;hostname&gt;      Server hostname (default: <span class="number">127.0</span>.<span class="number">0.1</span>).</span><br><span class="line">  -p &lt;port&gt;          Server port (default: <span class="number">6379</span>).</span><br><span class="line">  -c                 Enable cluster mode (follow -ASK and -MOVED redirections).</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br></pre></td></tr></table></figure></p>
<p>测试简单的set命令：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~  redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.80</span> -p <span class="number">7002</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span>&gt; <span class="built_in">set</span> hello world</span><br><span class="line">-&gt; Redirected to slot [<span class="number">866</span>] located at <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span>&gt; <span class="built_in">set</span> hello2 world2</span><br><span class="line">-&gt; Redirected to slot [<span class="number">7486</span>] located at <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span>&gt; <span class="built_in">set</span> hello3 world3</span><br><span class="line">-&gt; Redirected to slot [<span class="number">3359</span>] located at <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span>&gt; <span class="built_in">set</span> hello4 world4</span><br><span class="line">-&gt; Redirected to slot [<span class="number">15864</span>] located at <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里，注意set一个key后，如果redis cluster计算出key在的slot不属于当前的实例，会做一个Redirect动作，到对应应该保存key的实例上，同时，对应的cli下面链接的redis实例也变成了新的实例，这也说明了，redis cluster会让client跳转，而不是代理。</p>
<p>另外一个测试，生成连续的10个key，看对应key在集群里的分布，如下：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  cat initkeys.sh</span><br><span class="line"><span class="keyword">for</span> (( i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++ )); <span class="keyword">do</span></span><br><span class="line">    redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.80</span> -p <span class="number">700</span><span class="variable">$i</span> flushdb</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> (( i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ )); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"set foo<span class="variable">$&#123;i&#125;</span>:"</span></span><br><span class="line">    redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.80</span> -p <span class="number">7000</span> <span class="built_in">set</span> foo<span class="variable">$i</span> bar</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">➜  $  ./initkeys.sh</span><br></pre></td></tr></table></figure></p>
<p>这时，查看生成的key的分布：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  cat listkeys.sh</span><br><span class="line"><span class="keyword">for</span> (( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i )); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"redis at port: 700<span class="variable">$&#123;i&#125;</span>"</span></span><br><span class="line">    redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.7</span> -p <span class="number">700</span><span class="variable">$i</span> keys <span class="string">"*"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">➜  $  ./listkeys.sh</span><br><span class="line">redis at port: <span class="number">7000</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo3"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo7"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo6"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"foo2"</span></span><br><span class="line">redis at port: <span class="number">7001</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo4"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo8"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo0"</span></span><br><span class="line">redis at port: <span class="number">7002</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo9"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo5"</span></span><br><span class="line">redis at port: <span class="number">7003</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo7"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo3"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo2"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"foo6"</span></span><br><span class="line">redis at port: <span class="number">7004</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo4"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo8"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo0"</span></span><br><span class="line">redis at port: <span class="number">7005</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo9"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo5"</span></span><br></pre></td></tr></table></figure></p>
<p>注意，slave里的key分布是和master一致的。</p>
<h2 id="u6DFB_u52A0_u8282_u70B9"><a href="#u6DFB_u52A0_u8282_u70B9" class="headerlink" title="添加节点"></a>添加节点</h2><p>按照同样的方式，创建7006/7007两个新的redis实例。</p>
<p>并运行<code>redis-trib.rb add-node</code>，把对应的7006实例添加到集群中：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  redis-server <span class="number">7006</span>/redis.conf</span><br><span class="line">➜  $  ../redis-trib.rb add-node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span> <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">&gt;&gt;&gt; Adding node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span> to cluster <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span>)</span><br><span class="line">M: f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">   slots:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">S: <span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861</span><br><span class="line">M: <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span></span><br><span class="line">   slots:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">M: bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span></span><br><span class="line">   slots:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">S: <span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates bc86c1677869e05b6119139a838b06181f8378a2</span><br><span class="line">S: <span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates f822e285d00305a3158408185abf838639b3db3e</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span> to make it join the cluster.</span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure></p>
<p>新节点添加到cluster里了，接下来，查看一下集群信息：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.80</span> -p <span class="number">7000</span> cluster nodes</span><br><span class="line">f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span> myself,master - <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line">ee016572fb68ff192276fd8dd83ab1429a534b43 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span> master - <span class="number">0</span> <span class="number">1453941587053</span> <span class="number">0</span> connected</span><br><span class="line"><span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span> slave <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">0</span> <span class="number">1453941592097</span> <span class="number">5</span> connected</span><br><span class="line"><span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span> master - <span class="number">0</span> <span class="number">1453941591592</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br><span class="line">bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span> master - <span class="number">0</span> <span class="number">1453941591089</span> <span class="number">3</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br><span class="line"><span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span> slave bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">0</span> <span class="number">1453941590083</span> <span class="number">6</span> connected</span><br><span class="line"><span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span> slave f822e285d00305a3158408185abf838639b3db3e <span class="number">0</span> <span class="number">1453941589074</span> <span class="number">4</span> connected</span><br></pre></td></tr></table></figure></p>
<p>注意，这时，7006对应的实例是master，但是分配的slots是0，这种情况下是不会有任何key分配到7006的。需要对cluster做一次reshard，重新分配集群的slots后才能有key分配过来。</p>
<p>redis clust的reshard语法为：<code>./redis-trib.rb reshard &lt;host&gt;:&lt;port&gt; --from &lt;node-id&gt; --to &lt;node-id&gt; --slots --yes</code>，也可以不指定<code>from</code>和<code>to</code>节点，通过向导的方式进行分配，如：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  ../src/redis-trib.rb reshard <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span>)</span><br><span class="line">M: f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">   slots:<span class="number">1666</span>-<span class="number">5460</span> (<span class="number">3795</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">M: ee016572fb68ff192276fd8dd83ab1429a534b43 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">S: <span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861</span><br><span class="line">M: <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span></span><br><span class="line">   slots:<span class="number">7128</span>-<span class="number">10922</span> (<span class="number">3795</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">M: bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span></span><br><span class="line">   slots:<span class="number">12589</span>-<span class="number">16383</span> (<span class="number">3795</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">S: <span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates bc86c1677869e05b6119139a838b06181f8378a2</span><br><span class="line">S: <span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates f822e285d00305a3158408185abf838639b3db3e</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from <span class="number">1</span> to <span class="number">16384</span>)? <span class="number">5000</span></span><br><span class="line">What is the receiving node ID? ee016572fb68ff192276fd8dd83ab1429a534b43</span><br></pre></td></tr></table></figure></p>
<p>这里会终端让你输入需要分配多少个slots以及分配到哪个实例上，输入后，则会显示所有的slots从旧节点到新节点的迁移过程，如：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Moving slot <span class="number">12587</span> from <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span> to <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span>:</span><br><span class="line">Moving slot <span class="number">12588</span> from <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span> to <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span>:</span><br></pre></td></tr></table></figure></p>
<p>这时，查看集群信息：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.80</span> -p <span class="number">7000</span> cluster nodes</span><br><span class="line">f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span> myself,master - <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> connected <span class="number">1666</span>-<span class="number">5460</span></span><br><span class="line">ee016572fb68ff192276fd8dd83ab1429a534b43 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span> master - <span class="number">0</span> <span class="number">1453942147886</span> <span class="number">7</span> connected <span class="number">0</span>-<span class="number">1665</span> <span class="number">5461</span>-<span class="number">7127</span> <span class="number">10923</span>-<span class="number">12588</span></span><br><span class="line"><span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span> slave <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">0</span> <span class="number">1453942144357</span> <span class="number">5</span> connected</span><br><span class="line"><span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span> master - <span class="number">0</span> <span class="number">1453942150409</span> <span class="number">2</span> connected <span class="number">7128</span>-<span class="number">10922</span></span><br><span class="line">bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span> master - <span class="number">0</span> <span class="number">1453942149401</span> <span class="number">3</span> connected <span class="number">12589</span>-<span class="number">16383</span></span><br><span class="line"><span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span> slave bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">0</span> <span class="number">1453942148391</span> <span class="number">6</span> connected</span><br><span class="line"><span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span> slave f822e285d00305a3158408185abf838639b3db3e <span class="number">0</span> <span class="number">1453942147381</span> <span class="number">4</span> connected</span><br></pre></td></tr></table></figure></p>
<p>你会发现，当前4个master，3个slave，7006对应的slots已经分配，7006实例是没有slave的。</p>
<p>检查当前的key分布，key的位置发生了调整，7006上也有key了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  ./listkeys.sh</span><br><span class="line">redis at port: <span class="number">7000</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo3"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo7"</span></span><br><span class="line">redis at port: <span class="number">7001</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo4"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo8"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo0"</span></span><br><span class="line">redis at port: <span class="number">7002</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo9"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo5"</span></span><br><span class="line">redis at port: <span class="number">7003</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo7"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo3"</span></span><br><span class="line">redis at port: <span class="number">7004</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo4"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo8"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo0"</span></span><br><span class="line">redis at port: <span class="number">7005</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo9"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"foo5"</span></span><br><span class="line">redis at port: <span class="number">7006</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"foo6"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"foo2"</span></span><br></pre></td></tr></table></figure>
<p>这时，启动7007实例，并把它添加为7006的slave节点，如下：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  redis-server <span class="number">7007</span>/redis.conf</span><br><span class="line"></span><br><span class="line">➜  $  ../redis-trib.rb add-node --slave --master-id ee016572fb68ff192276fd8dd83ab1429a534b43 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7007</span> <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">&gt;&gt;&gt; Adding node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7007</span> to cluster <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span>)</span><br><span class="line">M: f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span></span><br><span class="line">   slots:<span class="number">1666</span>-<span class="number">5460</span> (<span class="number">3795</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">M: ee016572fb68ff192276fd8dd83ab1429a534b43 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span></span><br><span class="line">   slots:<span class="number">0</span>-<span class="number">1665</span>,<span class="number">5461</span>-<span class="number">7127</span>,<span class="number">10923</span>-<span class="number">12588</span> (<span class="number">4999</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">S: <span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861</span><br><span class="line">M: <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span></span><br><span class="line">   slots:<span class="number">7128</span>-<span class="number">10922</span> (<span class="number">3795</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">M: bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span></span><br><span class="line">   slots:<span class="number">12589</span>-<span class="number">16383</span> (<span class="number">3795</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">S: <span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates bc86c1677869e05b6119139a838b06181f8378a2</span><br><span class="line">S: <span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates f822e285d00305a3158408185abf838639b3db3e</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7007</span> to make it join the cluster.</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join.</span><br><span class="line">&gt;&gt;&gt; Configure node as replica of <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span>.</span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure></p>
<h2 id="u5DF2_u6709_u8282_u70B9_u7684_u4E0B_u7EBF_u3001_u4E0A_u7EBF"><a href="#u5DF2_u6709_u8282_u70B9_u7684_u4E0B_u7EBF_u3001_u4E0A_u7EBF" class="headerlink" title="已有节点的下线、上线"></a>已有节点的下线、上线</h2><p>我们通过kill掉一个进程7006来模拟redis实例挂掉的情况：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  ps -ef | grep <span class="number">7006</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs <span class="built_in">kill</span></span><br><span class="line">➜  $  redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.80</span> -p <span class="number">7000</span> cluster nodes</span><br><span class="line">f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span> myself,master - <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> connected <span class="number">1666</span>-<span class="number">5460</span></span><br><span class="line">ee016572fb68ff192276fd8dd83ab1429a534b43 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span> master,fail - <span class="number">1453942479213</span> <span class="number">1453942473057</span> <span class="number">7</span> disconnected</span><br><span class="line"><span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span> slave <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">0</span> <span class="number">1453942501726</span> <span class="number">5</span> connected</span><br><span class="line"><span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span> master - <span class="number">0</span> <span class="number">1453942498379</span> <span class="number">2</span> connected <span class="number">7128</span>-<span class="number">10922</span></span><br><span class="line">bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span> master - <span class="number">0</span> <span class="number">1453942503450</span> <span class="number">3</span> connected <span class="number">12589</span>-<span class="number">16383</span></span><br><span class="line"><span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span> slave bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">0</span> <span class="number">1453942501420</span> <span class="number">6</span> connected</span><br><span class="line"><span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span> slave f822e285d00305a3158408185abf838639b3db3e <span class="number">0</span> <span class="number">1453942502436</span> <span class="number">4</span> connected</span><br><span class="line"><span class="number">261</span>efedb181985a24731c1f17353a379c86efe5b <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7007</span> master - <span class="number">0</span> <span class="number">1453942500405</span> <span class="number">8</span> connected <span class="number">0</span>-<span class="number">1665</span> <span class="number">5461</span>-<span class="number">7127</span> <span class="number">10923</span>-<span class="number">12588</span></span><br></pre></td></tr></table></figure></p>
<p>这时，7007（原来7006的slave）会自动被提升为master，而7006会显示fail的状态。</p>
<p>重新启动7006:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  $  redis-server <span class="number">7006</span>/redis.conf</span><br><span class="line">➜  $  redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.80</span> -p <span class="number">7000</span> cluster nodes</span><br><span class="line">f822e285d00305a3158408185abf838639b3db3e <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7000</span> myself,master - <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> connected <span class="number">1666</span>-<span class="number">5460</span></span><br><span class="line">ee016572fb68ff192276fd8dd83ab1429a534b43 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7006</span> slave <span class="number">261</span>efedb181985a24731c1f17353a379c86efe5b <span class="number">0</span> <span class="number">1453942543558</span> <span class="number">8</span> connected</span><br><span class="line"><span class="number">87</span><span class="built_in">cd</span>77a57f5074a01117243516b0dbfb4fd725fd <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7004</span> slave <span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">0</span> <span class="number">1453942544465</span> <span class="number">5</span> connected</span><br><span class="line"><span class="number">943</span>e0d3987a4bdfa35229cc46ecc5e0c4c64c861 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7001</span> master - <span class="number">0</span> <span class="number">1453942542034</span> <span class="number">2</span> connected <span class="number">7128</span>-<span class="number">10922</span></span><br><span class="line">bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7002</span> master - <span class="number">0</span> <span class="number">1453942541015</span> <span class="number">3</span> connected <span class="number">12589</span>-<span class="number">16383</span></span><br><span class="line"><span class="number">030674361</span>cdc4dad424ae70115b2002908b40fe4 <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7005</span> slave bc86c1677869e05b6119139a838b06181f8378a2 <span class="number">0</span> <span class="number">1453942543457</span> <span class="number">6</span> connected</span><br><span class="line"><span class="number">42</span>a80e0c660a65d6fd3132baf9787a1ced899cee <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7003</span> slave f822e285d00305a3158408185abf838639b3db3e <span class="number">0</span> <span class="number">1453942546079</span> <span class="number">4</span> connected</span><br><span class="line"><span class="number">261</span>efedb181985a24731c1f17353a379c86efe5b <span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">7007</span> master - <span class="number">0</span> <span class="number">1453942545070</span> <span class="number">8</span> connected <span class="number">0</span>-<span class="number">1665</span> <span class="number">5461</span>-<span class="number">7127</span> <span class="number">10923</span>-<span class="number">12588</span></span><br></pre></td></tr></table></figure></p>
<p>这时，7006的角色会变成7007的slave。</p>
</div><div class="tags"><a href="/tags/bigdata/">bigdata</a><a href="/tags/redis/">redis</a></div><div class="post-nav"><a href="/2016/01/26/use-redis-bit-operation-to-do-realtime-metrics/" class="next">用redis的bit来快速实现用户信息统计<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'junhuih';
var disqus_identifier = '2016/01/27/start-to-use-redis-cluster/';
var disqus_title = '初步使用redis cluster集群';
var disqus_url = 'https://junhuih.com/2016/01/27/start-to-use-redis-cluster/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//junhuih.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="https://junhuih.com"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/net/">.net</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">bigdata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/others/">others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/security/" style="font-size: 15px;">security</a> <a href="/tags/varnish/" style="font-size: 15px;">varnish</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/httpclient/" style="font-size: 15px;">httpclient</a> <a href="/tags/bigdata/" style="font-size: 15px;">bigdata</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/dotnet/" style="font-size: 15px;">dotnet</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/node-js/" style="font-size: 15px;">node.js</a> <a href="/tags/magento/" style="font-size: 15px;">magento</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/https/" style="font-size: 15px;">https</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/sqoop/" style="font-size: 15px;">sqoop</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/others/" style="font-size: 15px;">others</a> <a href="/tags/net/" style="font-size: 15px;">.net</a> <a href="/tags/asp-net/" style="font-size: 15px;">asp.net</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/ehcache/" style="font-size: 15px;">ehcache</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/01/27/start-to-use-redis-cluster/">初步使用redis cluster集群</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/use-redis-bit-operation-to-do-realtime-metrics/">用redis的bit来快速实现用户信息统计</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/15/turn-website-from-http-to-https/">关于网站从http转到https</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/14/use-node-js-to-call-magento-api/">用node.js调用magento api</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/08/anti-xss-in-java-use-coverity-security-library/">anti-xss in java use coverity security library</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/06/use-redis-as-mybatis-cache-storage/">use redis as mybatis cache storage</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/05/custom-keygenerator-in-ehcache-with-spring/">custom keygenerator in ehcache with spring</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/04/Spring-Cacheable-annotation-with-google-guava-and-ehcache/">Spring @Cacheable annotation with google guava and ehcache</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/04/use-spring-resttemplate-and-apache-httpclient/">use spring resttemplate and apache httpclient</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/31/deploy-hexo-blog-to-github/">Deploy hexo blog to github</a></li></ul></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">Junhuih Notes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?8e4e20868ca997be7a75b457bd0ae31b";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></div></body></html>